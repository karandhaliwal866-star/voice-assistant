const statusDisplay = document.getElementById("status");
const transcriptDisplay = document.getElementById("transcript");
const mainUI = document.getElementById("main-ui");

const API_KEY = "AIzaSyCjfmw5NV_suyK1XfnNbquKO0CBM6wmb6I";

// --- VOICE SELECTION ---
let maleVoice = null;

function loadVoices() {
    const voices = window.speechSynthesis.getVoices();
    // Look for voices that sound male (names like Google UK English Male, Microsoft David, etc.)
    maleVoice = voices.find(v => v.name.includes('Male') || v.name.includes('Guy') || v.name.includes('David') || v.name.includes('Google UK English Male'));
}

// Voices aren't always ready immediately, so we listen for them
window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function speak(text) {
  window.speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);
  
  if (maleVoice) {
    msg.voice = maleVoice;
  }
  
  msg.pitch = 0.9; // Lower pitch for a more masculine sound
  msg.rate = 1;
  window.speechSynthesis.speak(msg);
}

// --- BRAIN WITH MEMORY ---
async function askNova(prompt) {
    mainUI.classList.remove("listening");
    mainUI.classList.add("thinking");
    statusDisplay.innerText = "Processing...";

    // Retrieve name from Memory
    const userName = localStorage.getItem("nova_user_name") || "User";
    
    // System Instruction including memory
    const systemPrompt = `You are Nova, a helpful male AI assistant. 
    The user's name is ${userName}. If they tell you a new name, acknowledge it. 
    Keep responses short and helpful.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: systemPrompt + " User: " + prompt }] }]
            })
        });

        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;

        // Logic to Save Name into Memory
        if (prompt.toLowerCase().includes("my name is")) {
            const words = prompt.split(" ");
            const newName = words[words.length - 1];
            localStorage.setItem("nova_user_name", newName);
        }

        const cleanText = aiText.replace(/\*/g, "");
        transcriptDisplay.innerText = cleanText;
        speak(cleanText);

    } catch (error) {
        speak("I'm having trouble with my connection.");
    } finally {
        mainUI.classList.remove("thinking");
        statusDisplay.innerText = "Standby";
    }
}

function start() {
  const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!Recognition) return alert("Browser not supported");

  const recognition = new Recognition();
  
  recognition.onstart = () => {
    mainUI.classList.add("listening");
    statusDisplay.innerText = "Listening...";
  };

  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    transcriptDisplay.innerText = '"' + text + '"';
    askNova(text);
  };

  recognition.onend = () => {
    mainUI.classList.remove("listening");
  };

  recognition.start();
}
